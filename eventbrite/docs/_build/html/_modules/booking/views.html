<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>booking.views &mdash; eventbrite documntation 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            eventbrite documntation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">eventbrite</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">eventbrite documntation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">booking.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for booking.views</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains several function based views for the booking app.</span>
<span class="sd">function:list_ticket_classes_by_event: A FBV thst Return a list of all ticket classes for a given event.</span>
<span class="sd">function:check_promo_code: A FBV Check whether a promo code is valid for a given event.</span>
<span class="sd">function:create_order: A FBV that create order with its order items and Return the data saved.</span>
<span class="sd">function:confirm_order: a FBV that confirms the order by the sent token to user&#39;s email.</span>
<span class="sd">function:list_orders_by_user : a FBV that returns orders by user id.</span>
<span class="sd">function:list_orderitem_by_order : a FBV that return order items in an order by order id.</span>
<span class="sd">function:list_orderitem_by_user : a FBV that returns order items by user id.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># class:discount_list: A view that returns a list of all discounts or creates a new discount.</span>
<span class="c1"># class:discount_pk: A view that returns a discounts object or update a new discount or delete it.</span>

<span class="kn">import</span> <span class="nn">itsdangerous</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span><span class="p">,</span> <span class="n">EmailMessage</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">authentication_classes</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">TokenAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">event.serializers</span> <span class="kn">import</span> <span class="n">eventSerializer</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">event.models</span> <span class="kn">import</span> <span class="n">event</span> <span class="k">as</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">user.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">eventbrite.settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">rest_framework.authtoken.models</span> <span class="kn">import</span> <span class="n">Token</span>
<span class="kn">from</span> <span class="nn">user.authentication</span> <span class="kn">import</span> <span class="n">CustomTokenAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.status</span> <span class="kn">import</span> <span class="n">HTTP_200_OK</span><span class="p">,</span> <span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> <span class="n">HTTP_201_CREATED</span><span class="p">,</span> <span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> <span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span> <span class="n">HTTP_404_NOT_FOUND</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.core.signing</span> <span class="kn">import</span> <span class="n">TimestampSigner</span>
<span class="kn">from</span> <span class="nn">eventbrite.settings</span> <span class="kn">import</span> <span class="n">EMAIL_HOST_USER</span><span class="p">,</span> <span class="n">EMAIL_HOST_PASSWORD</span>


<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">QueryDict</span>


<div class="viewcode-block" id="list_ticket_classes_by_event"><a class="viewcode-back" href="../../booking.html#booking.views.list_ticket_classes_by_event">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_ticket_classes_by_event</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all ticket class for a given event.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param event_id: Event ID.</span>
<span class="sd">    :return: A list of JSON objects representing the bookings for the given event.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get all bookings for this event</span>
    <span class="n">ticket_classes</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">serialized_Ticket_classes</span> <span class="o">=</span> <span class="n">TicketClassSerializer</span><span class="p">(</span>
        <span class="n">ticket_classes</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># return the data as a  list of JSON objects</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_Ticket_classes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_promocode"><a class="viewcode-back" href="../../booking.html#booking.views.check_promocode">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_promocode</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether a promocode is valid for a given event.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param event_id: Event ID.</span>
<span class="sd">    :return: A JSON object indicating whether the promo code is valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start check promocode&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">promocode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;promocode&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;err&quot;</span><span class="p">:</span> <span class="s2">&quot;missing promocode param&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;promocode param found&quot;</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

    <span class="n">discount</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">EVENT_ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">,</span> <span class="n">CODE</span><span class="o">=</span><span class="n">promocode</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">discount</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;not found&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;discount was found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">discount</span><span class="o">.</span><span class="n">Quantity_available</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">discount</span><span class="o">.</span><span class="n">Quantity_available</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;quantity available = 0&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;availble quantity was found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">discount</span><span class="o">.</span><span class="n">Ends</span> <span class="o">==</span> <span class="s1">&#39;scheduled&#39;</span> <span class="ow">and</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="o">==</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_time</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;promocode has expired&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
    <span class="c1"># print(now.date())</span>
    <span class="c1"># print(discount.end_date)</span>
    <span class="c1"># print(str(now.date()) &gt; discount.end_date)</span>

    <span class="c1"># print(str(now.time())[0:8])</span>
    <span class="c1"># print(discount.end_time)</span>
    <span class="c1"># print(str(now.time())[0:8] &gt;= discount.end_time)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hasnt expired yet&quot;</span><span class="p">)</span>

    <span class="n">serialized_discount</span> <span class="o">=</span> <span class="n">DiscountSerializer</span><span class="p">(</span><span class="n">discount</span><span class="p">)</span>
    <span class="c1"># print(serialized_discount)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;discount&quot;</span><span class="p">:</span> <span class="n">serialized_discount</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>


<span class="c1"># fees</span>
<div class="viewcode-block" id="create_order"><a class="viewcode-back" href="../../booking.html#booking.views.create_order">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_order</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view creates an order for an event with the specified event ID.</span>
<span class="sd">    user ID are received in the request data. A discount code may also be included.</span>
<span class="sd">    request data should look like this</span>

<span class="sd">        {</span>
<span class="sd">            &quot;order_items&quot;:</span>
<span class="sd">            [</span>
<span class="sd">                {</span>
<span class="sd">                &quot;ticket_class_id&quot; : 1,	</span>
<span class="sd">                &quot;quantity&quot;: 3 </span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                &quot;ticket_class_id&quot; : 2,	</span>
<span class="sd">                &quot;quantity&quot;: 1 </span>
<span class="sd">                }</span>
<span class="sd">            ], </span>
<span class="sd">            &quot;promocode&quot; : &quot;DISCOUNT25&quot; // optional</span>

<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># validate data</span>

    <span class="c1"># check sent event_id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;no event exist with this ID&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
    <span class="c1"># check if a promocode was sent and validate it</span>
    <span class="n">promocode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promocode&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">promocode</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">discount</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">EVENT_ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">,</span> <span class="n">CODE</span><span class="o">=</span><span class="n">promocode</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">discount</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;not found&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">discount</span><span class="o">.</span><span class="n">Quantity_available</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">discount</span><span class="o">.</span><span class="n">Quantity_available</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;quantity available = 0&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">discount</span><span class="o">.</span><span class="n">Ends</span> <span class="o">==</span> <span class="s1">&#39;scheduled&#39;</span> <span class="ow">and</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="o">==</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">discount</span><span class="o">.</span><span class="n">end_time</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;is_valid_promocode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;promocode has expired&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

    <span class="c1"># get user data</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user_id was got from the request &quot;</span><span class="p">)</span>

    <span class="c1"># get order_items</span>
    <span class="n">order_items</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_items&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_items</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot; no order_items list of object was sent&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="c1"># create empty order so that orderitem can point to it</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="c1"># order.save()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------1--------&quot;</span><span class="p">)</span>

    <span class="c1"># for Calculate the order</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">amount_off</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------2-------&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_items</span><span class="p">:</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">ID</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;ticket_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">ID</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticket_class_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">PRICE</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ticket_class_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticket_class_id&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;no ticket class with this id. ticket_class_id = </span><span class="si">{</span><span class="w"> </span><span class="n">ticket_class_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_id</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="n">order_item_serializer</span> <span class="o">=</span> <span class="n">OrderItemSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order_item_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;order item serializer wasnt able to validate the data  </span><span class="si">{</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">error_messages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="n">order_item</span> <span class="o">=</span> <span class="n">order_item_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----3----------&quot;</span><span class="p">)</span>

        <span class="n">ticket_class</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">ID</span><span class="o">=</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">ticket_class_id</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">PRICE</span><span class="p">)</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">order_item_serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">quantity</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">quantity_sold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="n">order</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="c1"># order_item.delete()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Not enough tickets available for ticket class id </span><span class="si">{</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">ticket_class_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">subtotal</span> <span class="o">+=</span> <span class="n">ticket_class</span><span class="o">.</span><span class="n">PRICE</span> <span class="o">*</span> <span class="n">quantity</span>

        <span class="c1"># update ticket quantity sold</span>
        <span class="n">quantity_sold_updated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">quantity_sold</span><span class="p">)</span> <span class="o">+</span> <span class="n">quantity</span>
        <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">quantity_sold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">quantity_sold_updated</span><span class="p">))</span>

    <span class="c1"># handel discount if a promocode was sent</span>
    <span class="k">if</span> <span class="n">promocode</span><span class="p">:</span>
        <span class="n">order</span><span class="o">.</span><span class="n">discount_id</span> <span class="o">=</span> <span class="n">discount</span><span class="o">.</span><span class="n">ID</span>
        <span class="n">amount_off</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">discount</span><span class="o">.</span><span class="n">Discountـpercentage</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">*</span> <span class="n">subtotal</span>

        <span class="c1"># decrement Quantity_available of the used promocode</span>
        <span class="n">Quantity_available_updated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">discount</span><span class="o">.</span><span class="n">Quantity_available</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">discount</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">Quantity_available</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">Quantity_available_updated</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">discount</span><span class="o">.</span><span class="n">Discountـpercentage</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">discount</span><span class="o">.</span><span class="n">Discountـpercentage</span><span class="p">))</span>

    <span class="n">fee</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">-</span> <span class="n">amount_off</span> <span class="o">+</span> <span class="n">fee</span>

    <span class="c1"># Create the response</span>
    <span class="n">order_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tickets&#39;</span><span class="p">:</span> <span class="n">order_items</span><span class="p">,</span>
        <span class="s1">&#39;full_price&#39;</span><span class="p">:</span> <span class="n">subtotal</span><span class="p">,</span>
        <span class="s1">&#39;amount_off&#39;</span><span class="p">:</span> <span class="n">amount_off</span><span class="p">,</span>
        <span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total</span>
    <span class="p">}</span>
    <span class="n">order</span><span class="o">.</span><span class="n">full_price</span> <span class="o">=</span> <span class="n">subtotal</span>
    <span class="n">order</span><span class="o">.</span><span class="n">amount_off</span> <span class="o">=</span> <span class="n">amount_off</span>
    <span class="n">order</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">order</span><span class="o">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">event_id</span>
    <span class="n">order</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>
    <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># send_confirmation_email(request._request,order)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">order_response</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span></div>


<div class="viewcode-block" id="send_confirmation_email"><a class="viewcode-back" href="../../booking.html#booking.views.send_confirmation_email">[docs]</a><span class="k">def</span> <span class="nf">send_confirmation_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    This function should construct the url with a token and send the link by mail to the user </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======confirmation mail=======&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="c1"># Generate a confirmation token</span>
    <span class="n">signer</span> <span class="o">=</span> <span class="n">TimestampSigner</span><span class="p">()</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>
    <span class="c1"># token = generate_confirmation_token(order.id)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">confirmation_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">(</span>
        <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;confirm-order&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">token</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======1=======&quot;</span><span class="p">)</span>

    <span class="c1"># Build the confirmation URL</span>
    <span class="c1"># confirmation_url = request.build_absolute_uri(</span>
    <span class="c1">#     reverse(&#39;create-booking&#39;))  # , args=[token]))</span>

    <span class="c1"># token, created = Token.objects.get_or_create(user=user)</span>
    <span class="c1"># confirmation_url = &#39;google.com&#39;</span>
    <span class="c1"># confirmation_url = f&quot;https://example.com/confirm-email/?token={token.key}&quot;</span>

    <span class="c1"># Generate a QR code for the confirmation URL using the Google Charts API</span>
    <span class="n">qr_code_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://chart.googleapis.com/chart?chs=150x150&amp;cht=qr&amp;chl=</span><span class="si">{</span><span class="n">confirmation_url</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">qr_code_image</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qr_code_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======2=======&quot;</span><span class="p">)</span>

    <span class="c1"># Send the confirmation email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;Confirm your email address&#39;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Hi </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s1">, please click the link below or scan the QR code to confirm your booking:</span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">confirmation_url</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="n">from_email</span> <span class="o">=</span> <span class="s1">&#39;no-reply@example.com&#39;</span>
    <span class="n">recipient_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">recipient_list</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span>
                        <span class="n">recipient_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">EMAIL_HOST_USER</span><span class="p">)</span>
    <span class="n">send_mail</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
              <span class="n">from_email</span><span class="o">=</span><span class="n">from_email</span><span class="p">,</span>
              <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">recipient_list</span><span class="o">=</span><span class="n">recipient_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======3=======&quot;</span><span class="p">)</span>

    <span class="c1"># ,content_type=&#39;image/png&#39;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;qrcode.png&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">qr_code_image</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
    <span class="c1"># send_mail(message=mail, subject=subject,from_email=from_email,recipient_list=recipient_list , html_message=f&#39;&lt;p&gt;{message}&lt;/p&gt;&lt;img src=&quot;cid:qrcode&quot;&gt;&#39;, fail_silently=False)</span>
    <span class="c1"># Render a response</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====== end of function =======&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">201</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span></div>


<div class="viewcode-block" id="confirm_order"><a class="viewcode-back" href="../../booking.html#booking.views.confirm_order">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">confirm_order</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function confirms an order by taking a token as input and </span>
<span class="sd">    returning a response indicating whether the order has been validated. </span>
<span class="sd">    The token is used to retrieve the order ID, </span>
<span class="sd">    which is then used to update the order object&#39;s is_validated field to True. </span>
<span class="sd">    The function returns a response with the value of is_validated as True and a status code of 200 if successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=-=-=-=-= start confirm order==-=--=---=&quot;</span><span class="p">)</span>

    <span class="n">signer</span> <span class="o">=</span> <span class="n">TimestampSigner</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">order_id</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">unsign</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">86400</span><span class="p">)</span>  <span class="c1"># 86400 seconds = 1 day</span>
    <span class="k">except</span> <span class="n">signer</span><span class="o">.</span><span class="n">BadSignature</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid token&#39;</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=-=-=-=-= mid confirm order==-=--=---=&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">order_id</span><span class="p">)</span>
    <span class="n">order</span><span class="o">.</span><span class="n">is_validated</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">order_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_validated</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>

    <span class="c1"># order.save()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=-=-=-=-= end confirm order==-=--=---=&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;is_validated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_orders_by_user"><a class="viewcode-back" href="../../booking.html#booking.views.list_orders_by_user">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_orders_by_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all orders for a given user.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param user_id: User ID.</span>
<span class="sd">    :return: A list of JSON objects representing the bookings for the given user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">serialized_orders</span> <span class="o">=</span> <span class="n">OrderSerializer</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_orders</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_orderitem_by_order"><a class="viewcode-back" href="../../booking.html#booking.views.list_orderitem_by_order">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_orderitem_by_order</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order_items</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">)</span>
    <span class="n">serialized_orderitems</span> <span class="o">=</span> <span class="n">OrderItemSerializer</span><span class="p">(</span><span class="n">order_items</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_orderitems</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_orderitem_by_user"><a class="viewcode-back" href="../../booking.html#booking.views.list_orderitem_by_user">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_orderitem_by_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a user_id as input and returns a list of OrderItem objects</span>
<span class="sd">    associated with the given user. </span>
<span class="sd">    It uses the OrderItemSerializer to serialize the data before returning it in the response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order_items</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">serialized_orderitems</span> <span class="o">=</span> <span class="n">OrderItemSerializer</span><span class="p">(</span><span class="n">order_items</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_orderitems</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="quantity_sold_out_of_total"><a class="viewcode-back" href="../../booking.html#booking.views.quantity_sold_out_of_total">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">quantity_sold_out_of_total</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view function that returns the ticket classes ids in an event associated with how many tickets were sold out of the total.</span>
<span class="sd">    It uses the TicketQuantityClassSerializer to serialize the data before returning it in the response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">event</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">User_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to create a ticket for this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
    <span class="n">ticket_classes</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">serialized_Ticket_classes</span> <span class="o">=</span> <span class="n">TicketQuantityClassSerializer</span><span class="p">(</span>
        <span class="n">ticket_classes</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_Ticket_classes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ismail.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>