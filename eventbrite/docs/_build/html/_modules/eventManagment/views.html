<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>eventManagment.views &mdash; eventbrite documntation 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            eventbrite documntation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">eventbrite</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">eventbrite documntation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">eventManagment.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for eventManagment.views</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains several view classes for the eventmanagement app.</span>

<span class="sd">class:UserListEvents: A viewset for retrieving all user events by user id.</span>

<span class="sd">class:UserListPastEvents: A viewset for retrieving all user past events by user id.</span>

<span class="sd">class:UserListEvents: A viewset for retrieving all user upcoming events by user id.</span>

<span class="sd">class:PromoCodeCreateAPIView: A viewser for creating a new promocode for a given event.</span>

<span class="sd">class:PromoCodeUpdateView: A view that update a promocode for a specific events given the discount id</span>

<span class="sd">class:APromocodeListView:  A view that to get a promocode for a specific events by discount id</span>

<span class="sd">class::EventPublishView:   A view for publish a specific event given the event ID</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">FileSystemStorage</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">event.serializers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>
<span class="kn">from</span> <span class="nn">user</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">event.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">booking.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">booking.serializers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">rest_framework.status</span> <span class="kn">import</span> <span class="n">HTTP_200_OK</span><span class="p">,</span> <span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> <span class="n">HTTP_201_CREATED</span><span class="p">,</span> <span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span> <span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span> <span class="n">HTTP_404_NOT_FOUND</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">user.authentication</span> <span class="kn">import</span> <span class="n">CustomTokenAuthentication</span>
<span class="kn">from</span> <span class="nn">booking.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">booking.serializers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">eventManagment.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">eventManagment.serializers</span> <span class="kn">import</span> <span class="n">Publish_InfoSerializer</span><span class="p">,</span> <span class="n">Password_Serializer</span>
<span class="kn">from</span> <span class="nn">eventManagment.forms</span> <span class="kn">import</span> <span class="n">Password_Form</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">authentication_classes</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span> <span class="nn">django.core.signing</span> <span class="kn">import</span> <span class="n">TimestampSigner</span>
<span class="kn">from</span> <span class="nn">eventbrite.settings</span> <span class="kn">import</span> <span class="n">EMAIL_HOST_USER</span><span class="p">,</span> <span class="n">EMAIL_HOST_PASSWORD</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span><span class="p">,</span> <span class="n">EmailMessage</span>


<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># server_url=&quot;https://event-us.me:8000/&quot;</span>
<span class="c1"># localhost_url=&quot;https://127.0.0.1:8080&quot;</span>
<span class="n">server_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;server_url&#39;</span><span class="p">)</span>
<span class="c1"># localhost_url=os.getenv(&#39;localhost_url&#39;)</span>


<div class="viewcode-block" id="UserListEvents"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.UserListEvents">[docs]</a><span class="k">class</span> <span class="nc">UserListEvents</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A viewset for retrieving all user events by user id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">eventSerializer</span>

<div class="viewcode-block" id="UserListEvents.get_queryset"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.UserListEvents.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This view should list all the user events</span>
<span class="sd">        for the given user id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># user_id = self.kwargs[&#39;user_id&#39;]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UserListPastEvents"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.UserListPastEvents">[docs]</a><span class="k">class</span> <span class="nc">UserListPastEvents</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A viewset for retrieving all user past events by user id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">eventSerializer</span>

<div class="viewcode-block" id="UserListPastEvents.get_queryset"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.UserListPastEvents.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This view should list all the user past </span>
<span class="sd">        events for the given user id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># user_id = self.kwargs[&#39;user_id&#39;]</span>
        <span class="c1"># data={&#39;STATUS&#39;: request.data.get(&#39;STATUS&#39;, &#39;Past&#39;),}</span>
        <span class="c1"># event.objects.filter(ID=event_id).update(**data)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ST_DATE__lt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UserListUpcomingEvents"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.UserListUpcomingEvents">[docs]</a><span class="k">class</span> <span class="nc">UserListUpcomingEvents</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A viewset for retrieving all user upcoming events by user id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">eventSerializer</span>

<div class="viewcode-block" id="UserListUpcomingEvents.get_queryset"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.UserListUpcomingEvents.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This view should list all the user upcoming</span>
<span class="sd">        events for the given user id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># user_id = self.kwargs[&#39;user_id&#39;]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ST_DATE__gt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PromoCodeCreateAPIView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.PromoCodeCreateAPIView">[docs]</a><span class="k">class</span> <span class="nc">PromoCodeCreateAPIView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">CreateAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view that creates a promocode for a specific events given the event id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">DiscountSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>

<div class="viewcode-block" id="PromoCodeCreateAPIView.post"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.PromoCodeCreateAPIView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Post request to create promocode for an event, and have the option to add a csv file instead of typying the promocode details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">event</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">User_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to create a promocode for this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No tickets created for event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1">. Cannot publish event without tickets.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="n">PromoCode_Data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">PromoCode_Data</span><span class="p">[</span><span class="s1">&#39;EVENT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">ID</span>
        <span class="n">PromoCode_Data</span><span class="p">[</span><span class="s1">&#39;User_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="c1"># parse CSV data</span>
            <span class="n">csv_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csv_data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
            <span class="c1"># create a promocode for each row in the CSV</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CODE</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">EVENT_ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Promocode with code </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1"> already exists for this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
                <span class="n">promo_code_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;EVENT_ID&#39;</span><span class="p">:</span> <span class="n">event_id</span><span class="p">,</span>
                    <span class="s1">&#39;User_ID&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s1">&#39;CODE&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Ticket_limit&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ticket_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Limitedamount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limited_amount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limited_amount&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;Reveal_hidden&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reveal_hidden&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reveal_hidden&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;Discountـpercentage&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_percentage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_percentage&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;Discount_price&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_price&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_price&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;Starts&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;Ends&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ends&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ends&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="c1"># &#39;start_date&#39;: row.get(&#39;start_date&#39;, &#39;&#39;),</span>
                    <span class="c1"># &#39;start_time&#39;: row.get(&#39;start_time&#39;, &#39;&#39;),</span>
                    <span class="c1"># &#39;end_date&#39;: row.get(&#39;end_date&#39;, &#39;&#39;),</span>
                    <span class="s1">&#39;Quantity_available&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantity_available&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantity_available&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># Only include start_date and start_time if they exist and are not empty</span>
                <span class="k">if</span> <span class="s1">&#39;start_date&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]:</span>
                    <span class="n">promo_code_data</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;start_time&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]:</span>
                    <span class="n">promo_code_data</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
                <span class="c1"># Only include end_date if it exists and is not empty</span>
                <span class="k">if</span> <span class="s1">&#39;end_date&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]:</span>
                    <span class="n">promo_code_data</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;end_time&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]:</span>
                    <span class="n">promo_code_data</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>
                <span class="n">serializer</span> <span class="o">=</span> <span class="n">DiscountSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">promo_code_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                    <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Promo codes created from CSV file.&#39;</span><span class="p">})</span>
        <span class="c1"># no file was uploaded, create a single promocode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">PromoCode_Data</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">PromoCode_Data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CODE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">and</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CODE</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Promo code &quot;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">&quot; already exists.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="validate_password"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.validate_password">[docs]</a><span class="k">def</span> <span class="nf">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="APromocodeListView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.APromocodeListView">[docs]</a><span class="k">class</span> <span class="nc">APromocodeListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view that to get a promocode for a specific events by discount id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">DiscountSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>

<div class="viewcode-block" id="APromocodeListView.get"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.APromocodeListView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">discount_id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ticket_classes</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">discount_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Discount</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Event does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ticket_class</span> <span class="ow">in</span> <span class="n">ticket_classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">User_ID</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to list this promocode.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">DiscountSerializer</span><span class="p">(</span><span class="n">ticket_classes</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PromoCodeUpdateView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.PromoCodeUpdateView">[docs]</a><span class="k">class</span> <span class="nc">PromoCodeUpdateView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view that update a promocode for a specific events given the discount id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>

<div class="viewcode-block" id="PromoCodeUpdateView.put"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.PromoCodeUpdateView.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">discount_id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">discount_obj</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">discount_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Discount</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Discount does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">discount_obj</span><span class="o">.</span><span class="n">User_ID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to update this discount.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;CODE&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CODE&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">CODE</span><span class="p">),</span>
            <span class="s1">&#39;Ticket_limit&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Ticket_limit&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Ticket_limit</span><span class="p">),</span>
            <span class="s1">&#39;Limitedamount&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Limitedamount&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Limitedamount</span><span class="p">),</span>
            <span class="s1">&#39;Reveal_hidden&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Reveal_hidden&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Reveal_hidden</span><span class="p">),</span>
            <span class="s1">&#39;Discountـpercentage&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Discountـpercentage&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Discountـpercentage</span><span class="p">),</span>
            <span class="s1">&#39;Discount_price&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Discount_price&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Discount_price</span><span class="p">),</span>
            <span class="s1">&#39;Starts&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Starts&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Starts</span><span class="p">),</span>
            <span class="s1">&#39;Ends&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Ends&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Ends</span><span class="p">),</span>
            <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">start_date</span><span class="p">),</span>
            <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>
            <span class="s1">&#39;end_date&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_date&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">end_date</span><span class="p">),</span>
            <span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_time&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">end_time</span><span class="p">),</span>
            <span class="s1">&#39;Quantity_available&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Quantity_available&#39;</span><span class="p">,</span> <span class="n">discount_obj</span><span class="o">.</span><span class="n">Quantity_available</span><span class="p">),</span>
            <span class="c1"># &#39;file&#39;: request.data.get(&#39;file&#39;, discount_obj.file),</span>
        <span class="p">}</span>
        <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">discount_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Discount updated successfully&#39;</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="PromoCodeDeleteView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.PromoCodeDeleteView">[docs]</a><span class="k">class</span> <span class="nc">PromoCodeDeleteView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A viewset for deleting a discount for an event by Discount ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>

<div class="viewcode-block" id="PromoCodeDeleteView.delete"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.PromoCodeDeleteView.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">discount_id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">promocodes</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">discount_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Discount</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Event does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">promocode</span> <span class="ow">in</span> <span class="n">promocodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">promocode</span><span class="o">.</span><span class="n">User_ID</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to delete this ticket class.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="n">num_deleted</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">promocodes</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_deleted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Could not delete ticket class.&#39;</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="EventPublishView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.EventPublishView">[docs]</a><span class="k">class</span> <span class="nc">EventPublishView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">CreateAPIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view for publish a specific event given the event ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">Publish_InfoSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Publish_Info</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomTokenAuthentication</span><span class="p">]</span>

<div class="viewcode-block" id="EventPublishView.post"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.EventPublishView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">event</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Publish_Info</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Event_ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1"> already is published.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Event_Status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Private&#39;</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Audience_Password&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Audience_Password&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Audience Password is required for private events.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Password must contain at least 8 characters.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="c1"># if request.data.get(&#39;Keep_Private&#39;) and request.data.get(&#39;Publication_Date&#39;):</span>
            <span class="c1">#     return Response({&#39;error&#39;: &#39;Do not add date, as your event will be kept private&#39;}, status=HTTP_400_BAD_REQUEST)</span>

                <span class="c1"># Publish_Info.objects.filter(ID=event_id).update(Publication_Date=&#39; &#39;)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No tickets created for event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1">. Cannot publish event without tickets.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">Publish_Data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Publish_Data</span><span class="p">[</span><span class="s1">&#39;Event_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_id</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Keep_Private&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
            <span class="n">Publish_Data</span><span class="p">[</span><span class="s1">&#39;Publication_Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Keep_Private&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Publication_Date&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Please Provide a Publish Date.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">Publish_Data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">User_id</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to publish this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;STATUS&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;STATUS&#39;</span><span class="p">,</span> <span class="s1">&#39;Live&#39;</span><span class="p">),</span> <span class="p">}</span>
            <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">errors</span>
            <span class="n">error_msgs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">errors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">error_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error_msgs</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CheckPasswordAPIView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.CheckPasswordAPIView">[docs]</a><span class="k">class</span> <span class="nc">CheckPasswordAPIView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">CreateAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">Password_Serializer</span>

<div class="viewcode-block" id="CheckPasswordAPIView.post"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.CheckPasswordAPIView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">publish_info</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publish_Info</span><span class="p">,</span> <span class="n">Event_ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">Password_Form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">publish_info</span><span class="o">.</span><span class="n">Audience_Password</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://127.0.0.1:8080/events/ID/</span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;Invalid Password&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ExportEventsAPIView"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.ExportEventsAPIView">[docs]</a><span class="k">class</span> <span class="nc">ExportEventsAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="c1"># permission_classes = [IsAuthenticated]</span>
    <span class="c1"># authentication_classes = [CustomTokenAuthentication]</span>
<div class="viewcode-block" id="ExportEventsAPIView.get"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.ExportEventsAPIView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Fetch events created by the specified user</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="c1"># Create the HttpResponse object with CSV headers</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/csv&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;events.csv&quot;&#39;</span>
        <span class="c1"># Create a CSV writer object</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1"># Write the CSV headers</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Event&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Status&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Tickets Sold&#39;</span><span class="p">,</span> <span class="s1">&#39;Tickets Available&#39;</span><span class="p">])</span>
        <span class="c1"># Write the event data rows</span>
        <span class="k">for</span> <span class="n">Event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">tickets_sold</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="n">total_sold</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;quantity_sold&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_sold&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tickets_available</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">Event</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                <span class="n">total_capacity</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;capacity&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_capacity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Handle None values and provide default values for subtraction</span>
            <span class="n">tickets_sold</span> <span class="o">=</span> <span class="n">tickets_sold</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">tickets_available</span> <span class="o">=</span> <span class="n">tickets_available</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">Event</span><span class="o">.</span><span class="n">Title</span><span class="p">,</span>
                <span class="n">Event</span><span class="o">.</span><span class="n">ST_DATE</span><span class="p">,</span>
                <span class="n">Event</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span>
                <span class="n">tickets_sold</span><span class="p">,</span>
                <span class="n">tickets_available</span> <span class="o">-</span> <span class="n">tickets_sold</span>
            <span class="p">])</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<span class="c1"># managee attendee</span>
<div class="viewcode-block" id="add_attendee"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.add_attendee">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_attendee</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this allows the organizer to add attendee if user doesnt exist it will be created one,</span>
<span class="sd">    This view creates an order for an event with the specified event ID.</span>
<span class="sd">    user ID are received in the request data. A discount code may also be included.</span>
<span class="sd">    request data should look like this</span>

<span class="sd">        {</span>
<span class="sd">            &quot;order_items&quot;:</span>
<span class="sd">            [</span>
<span class="sd">                {</span>
<span class="sd">                &quot;ticket_class_id&quot; : 1,	</span>
<span class="sd">                &quot;quantity&quot;: 3 </span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                &quot;ticket_class_id&quot; : 2,	</span>
<span class="sd">                &quot;quantity&quot;: 1 </span>
<span class="sd">                }</span>
<span class="sd">            ],</span>
<span class="sd">            &quot;first_name&quot; : &quot;ahmed&quot;,</span>
<span class="sd">            &quot;last_name&quot; : &quot;hamed&quot;,</span>
<span class="sd">            &quot;email&quot; : &quot;ahmedhamed@gmail.com&quot;</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====== add attendee ======&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">User_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to add an attendee for this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

    <span class="n">first_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_name&#39;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot; no email was sent, sent data should look like this {</span>
<span class="s2">            &quot;order_items&quot;:</span>
<span class="s2">            [</span>
<span class="s2">                {</span>
<span class="s2">                &quot;ticket_class_id&quot; : 1,	</span>
<span class="s2">                &quot;quantity&quot;: 3 </span>
<span class="s2">                },</span>
<span class="s2">                {</span>
<span class="s2">                &quot;ticket_class_id&quot; : 2,	</span>
<span class="s2">                &quot;quantity&quot;: 1 </span>
<span class="s2">                }</span>
<span class="s2">            ],</span>
<span class="s2">            &quot;first_name&quot; : &quot;ahmed&quot;,</span>
<span class="s2">            &quot;last_name&quot; : &quot;hamed&quot;,</span>
<span class="s2">            &quot;email&quot; : &quot;ahmedhamed@gmail.com&quot;</span>

<span class="s2">        }&quot;&quot;&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">first_name</span><span class="o">=</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="n">last_name</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;you should create user&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ziad12345*&quot;</span>
        <span class="n">user_serializer</span> <span class="o">=</span> <span class="n">userSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">user_serializer</span><span class="o">.</span><span class="n">error_messages</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">user_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
        <span class="n">user_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">user_serializer</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user_serializer</span><span class="o">.</span><span class="n">instance</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user already exist&quot;</span><span class="p">)</span>

    <span class="c1"># create empty order so that orderitem can point to it</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------1--------&quot;</span><span class="p">)</span>

    <span class="c1"># Retrieve the request data</span>

    <span class="n">order_items</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_items&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_items</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;sent data should look like this {</span>
<span class="s2">            &quot;order_items&quot;:</span>
<span class="s2">            [</span>
<span class="s2">                {</span>
<span class="s2">                &quot;ticket_class_id&quot; : 1,	</span>
<span class="s2">                &quot;quantity&quot;: 3 </span>
<span class="s2">                },</span>
<span class="s2">                {</span>
<span class="s2">                &quot;ticket_class_id&quot; : 2,	</span>
<span class="s2">                &quot;quantity&quot;: 1 </span>
<span class="s2">                }</span>
<span class="s2">            ],</span>
<span class="s2">            &quot;first_name&quot; : &quot;ahmed&quot;,</span>
<span class="s2">            &quot;last_name&quot; : &quot;hamed&quot;,</span>
<span class="s2">            &quot;email&quot; : &quot;ahmedhamed@gmail.com&quot;</span>

<span class="s2">        }&quot;&quot;&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="c1"># data[&#39;order_id&#39;] = order.ID</span>
    <span class="c1"># print(data)</span>

    <span class="c1"># for Calculate the order</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">amount_off</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------2-------&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_items</span><span class="p">:</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">ID</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;ticket_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">ID</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticket_class_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">PRICE</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ticket_class_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticket_class_id&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;no ticket class with this id. ticket_class_id = </span><span class="si">{</span><span class="w"> </span><span class="n">ticket_class_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># item[&#39;ticket_price&#39;] = TicketClass.objects.get(</span>
        <span class="c1">#     ID=item[&quot;ticket_class_id&quot;]).PRICE</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_id</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="n">order_item_serializer</span> <span class="o">=</span> <span class="n">OrderItemSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order_item_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;order item serializer wasnt able to validate the data  </span><span class="si">{</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">error_messages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="n">order_item</span> <span class="o">=</span> <span class="n">order_item_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----3----------&quot;</span><span class="p">)</span>

        <span class="n">ticket_class</span> <span class="o">=</span> <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">ID</span><span class="o">=</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">ticket_class_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">PRICE</span><span class="p">)</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">order_item_serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">quantity</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">quantity_sold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="n">order</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="c1"># order_item.delete()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Not enough tickets available for ticket class id </span><span class="si">{</span><span class="n">order_item_serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">ticket_class_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">subtotal</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">PRICE</span><span class="p">)</span> <span class="o">*</span> <span class="n">quantity</span>

        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>

        <span class="n">quantity_sold_updated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">quantity_sold</span><span class="p">)</span> <span class="o">+</span> <span class="n">quantity</span>
        <span class="n">TicketClass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">ticket_class</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">quantity_sold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">quantity_sold_updated</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;no event exist with this ID&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="n">fee</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">fee</span>

    <span class="c1"># Create the order</span>
    <span class="n">order_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tickets&#39;</span><span class="p">:</span> <span class="n">order_items</span><span class="p">,</span>
        <span class="s1">&#39;full_price&#39;</span><span class="p">:</span> <span class="n">subtotal</span><span class="p">,</span>
        <span class="s1">&#39;amount_off&#39;</span><span class="p">:</span> <span class="n">amount_off</span><span class="p">,</span>
        <span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total</span>
    <span class="p">}</span>
    <span class="n">order</span><span class="o">.</span><span class="n">full_price</span> <span class="o">=</span> <span class="n">subtotal</span>
    <span class="n">order</span><span class="o">.</span><span class="n">amount_off</span> <span class="o">=</span> <span class="n">amount_off</span>
    <span class="n">order</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
    <span class="n">order</span><span class="o">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">event_id</span>
    <span class="n">order</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>
    <span class="c1"># order.save()</span>
    <span class="c1"># send_confirmation_email(request._request, order)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">order_response</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span></div>


<div class="viewcode-block" id="send_confirmation_email"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.send_confirmation_email">[docs]</a><span class="k">def</span> <span class="nf">send_confirmation_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    this function should construct the url with a token and send the link by mail to the user </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======confirmation mail=======&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="c1"># Generate a confirmation token</span>
    <span class="n">signer</span> <span class="o">=</span> <span class="n">TimestampSigner</span><span class="p">()</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="c1"># token = generate_confirmation_token(order.id)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">confirmation_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">(</span>
        <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;confirm-order&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">token</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======1=======&quot;</span><span class="p">)</span>

    <span class="c1"># Build the confirmation URL</span>
    <span class="c1"># confirmation_url = request.build_absolute_uri(</span>
    <span class="c1">#     reverse(&#39;create-booking&#39;))  # , args=[token]))</span>

    <span class="c1"># token, created = Token.objects.get_or_create(user=user)</span>
    <span class="c1"># confirmation_url = &#39;google.com&#39;</span>
    <span class="c1"># confirmation_url = f&quot;https://example.com/confirm-email/?token={token.key}&quot;</span>

    <span class="c1"># Generate a QR code for the confirmation URL using the Google Charts API</span>
    <span class="n">qr_code_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://chart.googleapis.com/chart?chs=150x150&amp;cht=qr&amp;chl=</span><span class="si">{</span><span class="n">confirmation_url</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">qr_code_image</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qr_code_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======2=======&quot;</span><span class="p">)</span>

    <span class="c1"># Send the confirmation email</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;Confirm your email address&#39;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Hi </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1">, please click the link below or scan the QR code to confirm your booking:</span><span class="se">\n\n</span><span class="s1"> </span><span class="si">{</span><span class="n">confirmation_url</span><span class="si">}</span><span class="s1"> </span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="n">from_email</span> <span class="o">=</span> <span class="s1">&#39;no-reply@example.com&#39;</span>
    <span class="n">recipient_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">recipient_list</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span>
                        <span class="n">recipient_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">EMAIL_HOST_USER</span><span class="p">)</span>
    <span class="n">send_mail</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
              <span class="n">from_email</span><span class="o">=</span><span class="n">from_email</span><span class="p">,</span>
              <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">recipient_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;to@example.com&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======3=======&quot;</span><span class="p">)</span>

    <span class="c1"># ,content_type=&#39;image/png&#39;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;qrcode.png&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">qr_code_image</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
    <span class="c1"># send_mail(message=mail, subject=subject,from_email=from_email,recipient_list=recipient_list , html_message=f&#39;&lt;p&gt;{message}&lt;/p&gt;&lt;img src=&quot;cid:qrcode&quot;&gt;&#39;, fail_silently=False)</span>
    <span class="c1"># Render a response</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;====== end of function =======&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">201</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_orders_by_event"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.list_orders_by_event">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_orders_by_event</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all orders for a given user.</span>

<span class="sd">    :param request: HTTP request object.</span>
<span class="sd">    :param user_id: User ID.</span>
<span class="sd">    :return: A list of JSON objects representing the bookings for the given user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">serialized_orders</span> <span class="o">=</span> <span class="n">OrderSerializer</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_orders</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_orderitem_by_event"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.list_orderitem_by_event">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_orderitem_by_event</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List of all order items in an event by event ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order_items</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">serialized_orderitems</span> <span class="o">=</span> <span class="n">OrderItemSerializer</span><span class="p">(</span><span class="n">order_items</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serialized_orderitems</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_password"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.generate_password">[docs]</a><span class="k">def</span> <span class="nf">generate_password</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a random password of specified length</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">characters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">password</span></div>


<span class="c1"># Dashboards</span>

<div class="viewcode-block" id="savecsv_orderitems_by_eventid"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.savecsv_orderitems_by_eventid">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">savecsv_orderitems_by_eventid</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is a view function to retrieve all orderitems made by users using event ID </span>
<span class="sd">    and used to view all attendees at event with the type of tickets they bought and their quantities.</span>
<span class="sd">    Then save them in a csv file for the attendee report.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">event</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">User_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to view the data of this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
    <span class="n">order_items</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">serialized_orderitems</span> <span class="o">=</span> <span class="n">DashboardOrderItemSerializer</span><span class="p">(</span>
        <span class="n">order_items</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">serialized_orderitems</span><span class="o">.</span><span class="n">data</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="c1"># users = [d[&#39;user_id&#39;] for d in json_data]</span>
    <span class="c1"># for id in users:</span>
    <span class="c1">#     user = User.objects.get(id=(id))</span>
    <span class="c1">#     user_serializer = userSerializer(user)</span>
    <span class="c1">#     data = user_serializer.data</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
        <span class="n">quantity_sold</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">])</span>
        <span class="c1"># quantity_sold = d[&#39;quantity&#39;]</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ticket_price&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity_sold</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">sum</span> <span class="o">+=</span> <span class="n">quantity_sold</span> <span class="o">*</span> <span class="n">price</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input: quantity_sold and price must be integers&quot;</span><span class="p">)</span>

    <span class="c1"># del json_data[3]</span>
    <span class="n">write_json_to_csv</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;attendee_report.csv&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">json_data</span><span class="p">,</span> <span class="s1">&#39;number of order&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;profit&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>


<div class="viewcode-block" id="dashboard_orderitems_by_eventid"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.dashboard_orderitems_by_eventid">[docs]</a><span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">CustomTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">dashboard_orderitems_by_eventid</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">event_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is a view function to retrieve all orderitems made by users using event ID </span>
<span class="sd">    and used to view all attendees at event with the type of tickets they bought and their quantities.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">event</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Event with id </span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">User_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You are not authorized to view the data of this event.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>

    <span class="n">order_items</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">serialized_orderitems</span> <span class="o">=</span> <span class="n">DashboardOrderItemSerializer</span><span class="p">(</span>
        <span class="n">order_items</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">serialized_orderitems</span><span class="o">.</span><span class="n">data</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="c1"># users = [d[&#39;user_id&#39;] for d in json_data]</span>
    <span class="c1"># for id in users:</span>
    <span class="c1">#     user = User.objects.get(id=(id))</span>
    <span class="c1">#     user_serializer = userSerializer(user)</span>
    <span class="c1">#     data = user_serializer.data</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
        <span class="c1"># quantity_sold = int(d[&#39;quantity&#39;])</span>
        <span class="n">quantity_sold</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">])</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ticket_price&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity_sold</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">sum</span> <span class="o">+=</span> <span class="n">quantity_sold</span> <span class="o">*</span> <span class="n">price</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input: quantity_sold and price must be integers&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">json_data</span><span class="p">,</span> <span class="s1">&#39;number of order&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;profit&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_json_to_csv"><a class="viewcode-back" href="../../eventManagment.html#eventManagment.views.write_json_to_csv">[docs]</a><span class="k">def</span> <span class="nf">write_json_to_csv</span><span class="p">(</span><span class="n">json_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="c1"># extract field names from the first JSON object in the list</span>
    <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># open the CSV file for writing</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>

        <span class="c1"># write the header row to the CSV file</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>

        <span class="c1"># write each JSON object to a row in the CSV file</span>
        <span class="k">for</span> <span class="n">json_obj</span> <span class="ow">in</span> <span class="n">json_list</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">json_obj</span><span class="p">)</span></div>

<span class="c1"># @api_view([&#39;GET&#39;])</span>
<span class="c1"># @authentication_classes([CustomTokenAuthentication])</span>
<span class="c1"># @permission_classes([IsAuthenticated])</span>
<span class="c1"># def savecsv_orderitems_by_eventid(request, event_id):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     This is a view function to retrieve all orderitems made by users using event ID</span>
<span class="c1">#     and save them in a csv file for the attendee report.</span>
<span class="c1">#     &#39;&#39;&#39;</span>

<span class="c1">#     try:</span>
<span class="c1">#             Event = event.objects.get(ID=event_id)</span>
<span class="c1">#             print(request.user.id)</span>
<span class="c1">#     except event.DoesNotExist:</span>
<span class="c1">#         return Response({&#39;error&#39;: f&#39;Event with id {event_id} does not exist.&#39;}, status=HTTP_400_BAD_REQUEST)</span>
<span class="c1">#     if str(request.user.id) != str(Event.User_id):</span>
<span class="c1">#             return Response({&#39;error&#39;: &#39;You are not authorized to create a ticket for this event.&#39;}, status=HTTP_401_UNAUTHORIZED)</span>
<span class="c1">#     order_items = OrderItem.objects.filter(event_id=event_id)</span>
<span class="c1">#     serialized_orderitems = DashboardOrderItemSerializer(order_items, many=True)</span>
<span class="c1">#     json_data = serialized_orderitems.data</span>
<span class="c1">#     count=len(json_data)</span>
<span class="c1">#     users = [d[&#39;user_id&#39;] for d in json_data]</span>
<span class="c1">#     attendees=[]</span>
<span class="c1">#     for ff in users:</span>
<span class="c1">#         user = User.objects.get(id=(ff))</span>
<span class="c1">#         user_serializer = userSerializer(user)</span>
<span class="c1">#         data = user_serializer.data</span>
<span class="c1">#         attendees.append(data)</span>

<span class="c1">#     emails=[]</span>
<span class="c1">#     for d in attendees:</span>
<span class="c1">#         emails.append(d[&#39;email&#39;])</span>
<span class="c1">#     sum=0</span>
<span class="c1">#     for d in json_data:</span>
<span class="c1">#         quantity_sold = int(d[&#39;quantity&#39;])</span>
<span class="c1">#         price=d[&#39;ticket_price&#39;]</span>
<span class="c1">#         sum+=int(quantity_sold*price)</span>
<span class="c1">#     headers = [&#39;Event ID&#39;, &#39;User ID&#39;, &#39;User Email&#39;, &#39;Order ID&#39;, &#39;Order Item ID&#39;, &#39;Ticket Type&#39;, &#39;Ticket Price&#39;, &#39;Quantity&#39;]</span>

<span class="c1">#     # Combine the events and json_data lists</span>
<span class="c1">#     rows = []</span>
<span class="c1">#     for item in json_data:</span>
<span class="c1">#         c=0</span>
<span class="c1">#         rows.append([event_id, item[&#39;user_id&#39;], emails[c], item[&#39;order_id&#39;], item[&#39;ticket_class_id&#39;], item[&#39;ticket_price&#39;], item[&#39;quantity&#39;]])</span>
<span class="c1">#         c+=1</span>

<span class="c1">#     # Write the data to a CSV file</span>
<span class="c1">#     filename = f&#39;{event_id}_attendee_report.csv&#39;</span>
<span class="c1">#     with open(filename, mode=&#39;w&#39;, newline=&#39;&#39;) as file:</span>
<span class="c1">#         writer = csv.writer(file)</span>
<span class="c1">#         writer.writerow(headers)</span>
<span class="c1">#         writer.writerows(rows)</span>

<span class="c1">#     return Response({&#39;data&#39;: json_data, &#39;number of order&#39;: count,&#39;profit&#39;:sum,&#39;user_email&#39;:emails},status=status.HTTP_200_OK)</span>

<span class="c1"># @api_view([&#39;GET&#39;])</span>
<span class="c1"># @authentication_classes([CustomTokenAuthentication])</span>
<span class="c1"># @permission_classes([IsAuthenticated])</span>
<span class="c1"># def dashboard_orderitems_by_eventid(request, event_id):</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     This is a view function to retrieve all orderitems made by users using event ID.</span>
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     try:</span>
<span class="c1">#             Event = event.objects.get(ID=event_id)</span>
<span class="c1">#             print(request.user.id)</span>
<span class="c1">#     except event.DoesNotExist:</span>
<span class="c1">#         return Response({&#39;error&#39;: f&#39;Event with id {event_id} does not exist.&#39;}, status=HTTP_400_BAD_REQUEST)</span>

<span class="c1">#     if str(request.user.id) != str(Event.User_id):</span>
<span class="c1">#             return Response({&#39;error&#39;: &#39;You are not authorized to create a ticket for this event.&#39;}, status=HTTP_401_UNAUTHORIZED)</span>

<span class="c1">#     order_items = OrderItem.objects.filter(event_id=event_id)</span>
<span class="c1">#     serialized_orderitems = DashboardOrderItemSerializer(order_items, many=True)</span>
<span class="c1">#     json_data = serialized_orderitems.data</span>
<span class="c1">#     count=len(json_data)</span>
<span class="c1">#     users = [d[&#39;user_id&#39;] for d in json_data]</span>
<span class="c1">#     attendees=[]</span>
<span class="c1">#     for id in users:</span>
<span class="c1">#         user = User.objects.get(id=(id))</span>
<span class="c1">#         user_serializer = userSerializer(user)</span>
<span class="c1">#         data = user_serializer.data</span>
<span class="c1">#         attendees.append(data)</span>
<span class="c1">#     emails=[]</span>
<span class="c1">#     for d in attendees:</span>
<span class="c1">#         emails.append(d[&#39;email&#39;])</span>

<span class="c1">#     print(emails)</span>
<span class="c1">#     sum=0</span>
<span class="c1">#     for d in json_data:</span>
<span class="c1">#         quantity_sold = int(d[&#39;quantity&#39;])</span>
<span class="c1">#         price=d[&#39;ticket_price&#39;]</span>
<span class="c1">#         sum+=int((quantity_sold*price))</span>

<span class="c1">#     return Response({&#39;data&#39;:json_data, &#39;number of order&#39;: count,&#39;profit&#39;:sum,&#39;user_email&#39;:emails},status=status.HTTP_200_OK)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ismail.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>